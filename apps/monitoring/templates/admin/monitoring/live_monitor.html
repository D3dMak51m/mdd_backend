{% extends 'unfold/layouts/base.html' %}
{% load i18n %}

{% block title %}Live Monitor | MDD{% endblock %}
{% block breadcrumbs %}{% endblock %}

{% block content %}
<div class="w-full bg-gradient-to-br from-slate-50 to-gray-100 rounded-2xl shadow-2xl overflow-hidden flex flex-col border border-gray-200" style="height: 85vh; min-height: 600px;">

    <!-- –ú–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ö–µ–¥–µ—Ä —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º -->
    <div class="relative overflow-hidden bg-gradient-to-r from-slate-900 via-purple-900 to-slate-900 px-6 py-5 shrink-0">
        <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω -->
        <div class="absolute inset-0 bg-grid-white/[0.05] bg-[size:30px_30px]"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-purple-500/20 via-transparent to-blue-500/20 animate-pulse-slow"></div>

        <div class="relative flex justify-between items-center">
            <div class="flex items-center gap-4">
                <!-- –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
                <div class="relative">
                    <div class="absolute inset-0 bg-red-500 rounded-full animate-ping opacity-75"></div>
                    <div class="relative flex h-4 w-4 rounded-full bg-red-500 shadow-lg shadow-red-500/50"></div>
                </div>

                <div>
                    <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                        <span class="material-symbols-outlined text-3xl">emergency</span>
                        –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –ú–û–ù–ò–¢–û–†–ò–ù–ì
                    </h1>
                    <p class="text-purple-200 text-sm mt-1">Real-time Emergency Response System</p>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –ø–∞–Ω–µ–ª—å -->
            <div class="flex items-center gap-4">
                <div id="last-update" class="hidden sm:flex items-center gap-2 px-4 py-2 rounded-xl bg-white/10 backdrop-blur-md border border-white/20">
                    <span class="material-symbols-outlined text-white text-sm">schedule</span>
                    <span class="text-xs text-white font-mono">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
                </div>

                <div id="connection-status" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-yellow-500/20 backdrop-blur-md border border-yellow-400/30">
                    <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                    <span class="text-xs font-bold text-yellow-100">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="grid grid-cols-1 md:grid-cols-4 h-full flex-1 relative overflow-hidden">

        <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∞–π–¥–±–∞—Ä -->
        <div class="col-span-1 bg-white/80 backdrop-blur-xl border-r border-gray-200 flex flex-col h-full overflow-hidden z-20 relative">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ª–µ–Ω—Ç—ã -->
            <div class="px-4 py-4 bg-gradient-to-r from-red-500 to-orange-600 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-white text-xl">notifications_active</span>
                    <span class="font-bold text-sm uppercase text-white tracking-wide">–ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã</span>
                </div>
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-white/20 backdrop-blur-sm">
                    <span class="text-white text-sm font-bold">{{ active_events|length }}</span>
                </div>
            </div>

            <!-- –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π -->
            <div id="events-list" class="flex-1 overflow-y-auto p-3 space-y-3" style="max-height: 100%;">
                {% for event in active_events %}
                <div id="event-{{ event.event_uid }}"
                     class="group relative overflow-hidden rounded-xl border-l-4 border-red-500 bg-gradient-to-r from-red-50 to-white hover:from-red-100 hover:to-red-50 cursor-pointer shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1"
                     onclick="focusMap({{ event.latlon.y|stringformat:'f' }}, {{ event.latlon.x|stringformat:'f' }})">

                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                    <div class="p-4">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <div class="p-1.5 rounded-lg bg-red-100">
                                    <span class="material-symbols-outlined text-red-600 text-sm">warning</span>
                                </div>
                                <span class="text-xs font-bold text-red-700 uppercase tracking-wide">
                                    {{ event.detected_type }}
                                </span>
                            </div>
                            <span class="text-xs text-gray-400 font-mono">{{ event.timestamp|date:"H:i" }}</span>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                        <div class="mb-3">
                            <div class="text-base font-bold text-gray-900 mb-1">
                                {{ event.user.full_name|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }}
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <span class="material-symbols-outlined text-xs">phone</span>
                                {{ event.user.phone_number }}
                            </div>
                        </div>

                        <!-- –§—É—Ç–µ—Ä -->
                        <div class="flex items-center justify-between pt-3 border-t border-red-100">
                            <div class="flex items-center gap-1 text-xs text-gray-500">
                                <span class="material-symbols-outlined text-sm">location_on</span>
                                <span>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã</span>
                            </div>
                            <div class="flex items-center gap-1 text-xs font-semibold text-red-600">
                                <div class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
                                <span>–ê–∫—Ç–∏–≤–Ω–æ</span>
                            </div>
                        </div>
                    </div>

                    <!-- –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç -->
                    <div class="absolute -right-6 -top-6 w-20 h-20 bg-red-500/10 rounded-full blur-2xl group-hover:bg-red-500/20 transition-all"></div>
                </div>
                {% empty %}
                <div class="flex flex-col items-center justify-center h-full p-8 text-center">
                    <div class="p-6 rounded-full bg-gradient-to-br from-green-100 to-emerald-100 mb-4">
                        <span class="material-symbols-outlined text-green-600 text-5xl">check_circle</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-700 mb-2">–í—Å–µ —Å–ø–æ–∫–æ–π–Ω–æ</h3>
                    <p class="text-sm text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</p>
                </div>
                {% endfor %}
            </div>
        </div>

       <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
        <div class="col-span-3 relative" style="background: #f8fafc;">
            <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π -->
            <div id="map-placeholder" class="absolute inset-0 flex flex-col items-center justify-center z-0" style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);">
                <div class="relative">
                    <div class="absolute inset-0 bg-purple-500 rounded-full blur-3xl opacity-30 animate-pulse"></div>
                    <span class="relative material-symbols-outlined text-purple-600 text-6xl animate-bounce">map</span>
                </div>
                <p class="text-gray-700 mt-4 text-lg font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
            <div id="map" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 10;"></div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
            <div class="absolute top-4 right-4 z-20 flex flex-col gap-2">
                <button class="p-3 rounded-xl bg-white/95 backdrop-blur-md shadow-lg border border-gray-200 hover:bg-white transition-all group">
                    <span class="material-symbols-outlined text-gray-700 group-hover:text-purple-600 transition-colors">my_location</span>
                </button>
                <button class="p-3 rounded-xl bg-white/95 backdrop-blur-md shadow-lg border border-gray-200 hover:bg-white transition-all group">
                    <span class="material-symbols-outlined text-gray-700 group-hover:text-purple-600 transition-colors">layers</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes pulse-slow {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.6; }
    }

    .animate-pulse-slow {
        animation: pulse-slow 4s ease-in-out infinite;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .animate-slideInRight {
        animation: slideInRight 0.4s ease-out;
    }

    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ */
    .bg-grid-white\/\[0\.05\] {
        background-image:
            linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
    }

    /* –§–∏–∫—Å –¥–ª—è Leaflet */
    .leaflet-container img.leaflet-tile,
    .leaflet-container img.leaflet-marker-icon,
    .leaflet-container img.leaflet-marker-shadow {
        max-width: none !important;
        max-height: none !important;
        width: auto !important;
        height: auto !important;
    }

    .leaflet-pane,
    .leaflet-tile,
    .leaflet-marker-icon,
    .leaflet-marker-shadow,
    .leaflet-tile-container,
    .leaflet-pane > svg,
    .leaflet-pane > canvas,
    .leaflet-zoom-box,
    .leaflet-image-layer,
    .leaflet-layer {
        position: absolute !important;
        left: 0;
        top: 0;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä SOS */
    .sos-marker {
        background: transparent;
        border: none;
    }

    .sos-marker-container {
        position: relative;
        width: 60px;
        height: 60px;
    }

    .sos-marker-pulse {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle, rgba(239, 68, 68, 0.6) 0%, transparent 70%);
        border-radius: 50%;
        animation: sos-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .sos-marker-dot {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: 4px solid white;
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5), 0 0 0 4px rgba(239, 68, 68, 0.2);
    }

    @keyframes sos-pulse {
        0% {
            transform: scale(0.5);
            opacity: 1;
        }
        70%, 100% {
            transform: scale(2.5);
            opacity: 0;
        }
    }

    /* –°—Ç–∏–ª–∏ popup */
    .leaflet-popup-content-wrapper {
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .leaflet-popup-tip {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* Scrollbar */
    #events-list::-webkit-scrollbar {
        width: 6px;
    }

    #events-list::-webkit-scrollbar-track {
        background: transparent;
    }

    #events-list::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }

    #events-list::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
    }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("üöÄ Live Monitor Init...");

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const mapEl = document.getElementById('map');
        if (!mapEl) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        console.log('Map container:', mapEl.offsetWidth, 'x', mapEl.offsetHeight);

        const map = L.map('map', {
            zoomControl: true,
            preferCanvas: false,
            scrollWheelZoom: true
        }).setView([41.311, 69.240], 12);

        // –°–≤–µ—Ç–ª–∞—è –∫–∞—Ä—Ç–∞ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        setTimeout(() => {
            map.invalidateSize();
            const placeholder = document.getElementById('map-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            console.log('Map initialized');
        }, 300);

        const sosIcon = L.divIcon({
            className: 'sos-marker',
            html: `
                <div class="sos-marker-container">
                    <div class="sos-marker-pulse"></div>
                    <div class="sos-marker-pulse" style="animation-delay: 0.5s;"></div>
                    <div class="sos-marker-dot"></div>
                </div>
            `,
            iconSize: [60, 60],
            iconAnchor: [30, 30],
            popupAnchor: [0, -30]
        });

        const markers = {};

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        window.addMarker = function(event) {
            if (markers[event.event_uid]) return;

            const marker = L.marker([event.lat, event.lon], {icon: sosIcon})
                .addTo(map)
                .bindPopup(`
                    <div class="p-4 min-w-[280px] bg-gradient-to-br from-white to-gray-50">
                        <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                            <div class="p-2 rounded-lg bg-red-100">
                                <span class="material-symbols-outlined text-red-600 text-xl">emergency</span>
                            </div>
                            <div>
                                <div class="font-bold text-red-600 text-sm uppercase tracking-wide">
                                    ${event.detected_type}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">–ê–∫—Ç–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤</div>
                            </div>
                        </div>
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center gap-2 text-sm text-gray-700">
                                <span class="material-symbols-outlined text-base">person</span>
                                <span class="font-semibold">${event.user_phone}</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span class="material-symbols-outlined text-sm">schedule</span>
                                <span>–¢–æ–ª—å–∫–æ —á—Ç–æ</span>
                            </div>
                        </div>
                        <a href="/admin/sos/sosevent/${event.id}/change/"
                           target="_blank"
                           class="block w-full py-2.5 px-4 text-center bg-gradient-to-r from-red-600 to-orange-600 text-white font-semibold rounded-lg hover:from-red-700 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl">
                            <span class="flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-sm">open_in_new</span>
                                –û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏
                            </span>
                        </a>
                    </div>
                `);

            markers[event.event_uid] = true;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            const list = document.getElementById('events-list');
            const emptyMsg = list.querySelector('.flex.flex-col.items-center');
            if(emptyMsg) emptyMsg.remove();

            const item = document.createElement('div');
            item.className = "group relative overflow-hidden rounded-xl border-l-4 border-red-500 bg-gradient-to-r from-red-50 to-white cursor-pointer shadow-md hover:shadow-xl transition-all duration-300 mb-3 animate-slideInRight";
            item.innerHTML = `
                <div class="p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-1.5 rounded-lg bg-red-100 animate-pulse">
                                <span class="material-symbols-outlined text-red-600 text-sm">emergency</span>
                            </div>
                            <span class="text-xs font-bold text-red-700 uppercase tracking-wide">
                                NEW: ${event.detected_type}
                            </span>
                        </div>
                        <span class="text-xs text-gray-400 font-mono">–°–µ–π—á–∞—Å</span>
                    </div>
                    <div class="text-base font-bold text-gray-900 mb-1">${event.user_phone}</div>
                    <div class="flex items-center justify-between pt-3 border-t border-red-100">
                        <div class="flex items-center gap-1 text-xs text-gray-500">
                            <span class="material-symbols-outlined text-sm">location_on</span>
                            <span>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã</span>
                        </div>
                        <div class="flex items-center gap-1 text-xs font-semibold text-red-600">
                            <div class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
                            <span>–ê–∫—Ç–∏–≤–Ω–æ</span>
                        </div>
                    </div>
                </div>
            `;
            item.onclick = () => map.flyTo([event.lat, event.lon], 16, { duration: 1.5 });
            list.prepend(item);

            // –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch(e) {
                console.warn('Audio notification failed:', e);
            }

            map.flyTo([event.lat, event.lon], 16, { duration: 1.5 });
        };

        window.focusMap = function(lat, lon) {
            map.flyTo([lat, lon], 16, { duration: 1.5, easeLinearity: 0.25 });
        };

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–±—ã—Ç–∏–π
        {% for event in active_events %}
            L.marker(
                [{{ event.latlon.y|stringformat:'f' }}, {{ event.latlon.x|stringformat:'f' }}],
                {icon: sosIcon}
            ).addTo(map).bindPopup(`
                <div class="p-4 min-w-[280px] bg-gradient-to-br from-white to-gray-50">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-200">
                        <div class="p-2 rounded-lg bg-red-100">
                            <span class="material-symbols-outlined text-red-600 text-xl">emergency</span>
                        </div>
                        <div>
                            <div class="font-bold text-red-600 text-sm uppercase tracking-wide">
                                {{ event.detected_type }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">–ê–∫—Ç–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤</div>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center gap-2 text-sm text-gray-700">
                            <span class="material-symbols-outlined text-base">person</span>
                            <span class="font-semibold">{{ event.user.phone_number }}</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <span class="material-symbols-outlined text-sm">schedule</span>
                            <span>{{ event.timestamp|date:"H:i" }}</span>
                        </div>
                    </div>
                    <a href="/admin/sos/sosevent/{{ event.id }}/change/"
                       target="_blank"
                       class="block w-full py-2.5 px-4 text-center bg-gradient-to-r from-red-600 to-orange-600 text-white font-semibold rounded-lg hover:from-red-700 hover:to-orange-700 transition-all shadow-lg hover:shadow-xl">
                        <span class="flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">open_in_new</span>
                            –û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏
                        </span>
                    </a>
                </div>
            `);
            markers['{{ event.event_uid }}'] = true;
        {% endfor %}

        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = protocol + window.location.host + '/ws/sos_events/';
        const statusDiv = document.getElementById('connection-status');
        const lastUpdateDiv = document.getElementById('last-update');

        let socket;

        function connectWs() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                statusDiv.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-xs font-bold text-green-100">ONLINE</span>
                `;
                statusDiv.className = "flex items-center gap-2 px-4 py-2 rounded-xl bg-green-500/20 backdrop-blur-md border border-green-400/30";
            };

            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                console.log('üì® Received:', data);

                if (data.type === 'sos_event') {
                    addMarker(data.payload);

                    const now = new Date();
                    lastUpdateDiv.innerHTML = `
                        <span class="material-symbols-outlined text-white text-sm">schedule</span>
                        <span class="text-xs text-white font-mono">
                            ${now.toLocaleTimeString('ru-RU')}
                        </span>
                    `;
                }
            };

            socket.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
            };

            socket.onclose = () => {
                console.log('‚ö†Ô∏è WebSocket disconnected');
                statusDiv.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-red-400"></div>
                    <span class="text-xs font-bold text-red-100">OFFLINE</span>
                `;
                statusDiv.className = "flex items-center gap-2 px-4 py-2 rounded-xl bg-red-500/20 backdrop-blur-md border border-red-400/30";

                setTimeout(connectWs, 3000);
            };
        }

        connectWs();
    });
</script>
{% endblock %}