{% extends 'unfold/layouts/base.html' %}
{% load i18n %}

{% block title %}Live Monitor | MDD{% endblock %}
{% block breadcrumbs %}{% endblock %}

{% block content %}
<div class="w-full bg-white dark:bg-gray-900 border dark:border-gray-700 shadow rounded-lg overflow-hidden flex flex-col" style="height: 85vh; min-height: 600px;">

    <!-- Хедер -->
    <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800 shrink-0">
        <h1 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <span class="relative flex h-3 w-3">
              <span id="ping-dot" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75 hidden"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
            </span>
            ОПЕРАТИВНЫЙ МОНИТОРИНГ
        </h1>
        <div class="flex items-center gap-4">
            <div id="last-update" class="text-xs text-gray-500 dark:text-gray-400 font-mono hidden sm:block">Ожидание...</div>
            <div id="connection-status" class="px-3 py-1 rounded text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-200">Подключение...</div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="grid grid-cols-1 md:grid-cols-4 h-full flex-1 relative overflow-hidden">

        <!-- Сайдбар (Список) -->
        <div class="col-span-1 border-r dark:border-gray-700 flex flex-col h-full overflow-hidden bg-white dark:bg-gray-900 z-20 relative">
            <div class="p-3 bg-gray-100 dark:bg-gray-800 border-b dark:border-gray-700 font-bold text-xs uppercase text-gray-500 dark:text-gray-400 flex justify-between">
                <span>Лента событий</span>
                <span class="bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 px-2 rounded">{{ active_events|length }}</span>
            </div>
            <div id="events-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                {% for event in active_events %}
                <div id="event-card-{{ event.event_uid }}"
                     class="p-3 rounded border-l-4 border-red-500 bg-gray-50 dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-gray-700 cursor-pointer border-t border-r border-b border-gray-200 dark:border-gray-700 shadow-sm transition-all"
                     onclick="openDetails('{{ event.event_uid }}')">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-red-600">{{ event.detected_type }}</span>
                        <span class="text-xs text-gray-400">{{ event.timestamp|date:"H:i" }}</span>
                    </div>
                    <div class="text-sm font-medium text-gray-900 dark:text-white mb-1">{{ event.user.full_name|default:"Пользователь" }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">{{ event.user.phone_number }}</div>
                </div>
                {% empty %}
                <div class="p-4 text-center text-gray-400 text-sm flex flex-col items-center justify-center h-40">Нет активных вызовов</div>
                {% endfor %}
            </div>
        </div>

        <!-- Карта и Панель Деталей -->
        <div class="col-span-3 relative bg-gray-200 dark:bg-gray-800 overflow-hidden">
            <div id="map" class="absolute inset-0 z-10" style="height: 100%; width: 100%;"></div>

            <!-- ПАНЕЛЬ ДЕТАЛЕЙ (Скрыта по умолчанию) -->
            <div id="details-panel" class="absolute top-0 right-0 h-full w-80 bg-white dark:bg-gray-900 shadow-2xl transform translate-x-full transition-transform duration-300 z-30 border-l dark:border-gray-700 flex flex-col">
                <!-- Шапка панели -->
                <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-red-50 dark:bg-red-900/20">
                    <h2 class="font-bold text-red-700 dark:text-red-400">Детали инцидента</h2>
                    <button onclick="closeDetails()" class="text-gray-500 hover:text-gray-800 dark:hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Контент панели -->
                <div class="p-4 flex-1 overflow-y-auto space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold">Тип угрозы</label>
                        <div id="detail-type" class="text-lg font-bold text-gray-900 dark:text-white">-</div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold">Пользователь</label>
                        <div id="detail-user" class="text-md text-gray-800 dark:text-gray-200">-</div>
                        <div id="detail-phone" class="text-sm text-gray-500">-</div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded">
                            <label class="text-[10px] text-gray-400 uppercase">Severity</label>
                            <div id="detail-severity" class="font-bold">-</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded">
                            <label class="text-[10px] text-gray-400 uppercase">Time</label>
                            <div id="detail-time" class="font-bold">-</div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold">Координаты</label>
                        <div id="detail-coords" class="font-mono text-sm bg-gray-100 dark:bg-gray-800 p-2 rounded select-all">-</div>
                    </div>

                    <div class="pt-4 border-t dark:border-gray-700">
                        <a id="detail-link" href="#" target="_blank" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors">
                            Открыть в админке
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .leaflet-container img.leaflet-tile, .leaflet-container img.leaflet-marker-icon, .leaflet-container img.leaflet-marker-shadow { max-width: none !important; max-height: none !important; width: auto !important; height: auto !important; }
    .leaflet-pane, .leaflet-tile, .leaflet-marker-icon, .leaflet-marker-shadow, .leaflet-tile-container, .leaflet-pane > svg, .leaflet-pane > canvas, .leaflet-zoom-box, .leaflet-image-layer, .leaflet-layer { position: absolute !important; left: 0; top: 0; }
    .sos-marker { background: transparent; border: none; }
    .sos-marker::before { content: ''; position: absolute; left: -10px; top: -10px; width: 40px; height: 40px; background-color: rgba(239, 68, 68, 0.5); border-radius: 50%; animation: pulse-ring 1.5s infinite; }
    .sos-marker::after { content: ''; position: absolute; left: 0; top: 0; width: 20px; height: 20px; background-color: #ef4444; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 1; } 80%, 100% { transform: scale(2); opacity: 0; } }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Хранилище данных событий на клиенте
    const eventsData = {};

    // Заполняем данными при загрузке (из Django)
    {% for event in active_events %}
        eventsData['{{ event.event_uid }}'] = {
            uid: '{{ event.event_uid }}',
            id: '{{ event.id }}',
            type: '{{ event.detected_type }}',
            user: '{{ event.user.full_name|default:"Пользователь" }}',
            phone: '{{ event.user.phone_number }}',
            lat: {{ event.latlon.y|stringformat:'f' }},
            lon: {{ event.latlon.x|stringformat:'f' }},
            time: '{{ event.timestamp|date:"H:i:s" }}',
            severity: {{ event.severity }}
        };
    {% endfor %}

    document.addEventListener("DOMContentLoaded", function() {
        const map = L.map('map').setView([41.311, 69.240], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
        setTimeout(() => { map.invalidateSize(); }, 300);

        const sosIcon = L.divIcon({ className: 'sos-marker', iconSize: [20, 20], iconAnchor: [10, 10] });
        const markers = {};

        // Функция открытия панели
        window.openDetails = function(uid) {
            const data = eventsData[uid];
            if (!data) return;

            // 1. Фокус карты
            map.flyTo([data.lat, data.lon], 16, { duration: 1.0 });

            // 2. Заполнение панели
            document.getElementById('detail-type').textContent = data.type;
            document.getElementById('detail-user').textContent = data.user;
            document.getElementById('detail-phone').textContent = data.phone;
            document.getElementById('detail-severity').textContent = data.severity;
            document.getElementById('detail-time').textContent = data.time;
            document.getElementById('detail-coords').textContent = `${data.lat.toFixed(5)}, ${data.lon.toFixed(5)}`;
            document.getElementById('detail-link').href = `/admin/sos/sosevent/${data.id}/change/`;

            // 3. Показ панели (убираем класс сдвига)
            document.getElementById('details-panel').classList.remove('translate-x-full');
        };

        window.closeDetails = function() {
            document.getElementById('details-panel').classList.add('translate-x-full');
        };

        window.addMarker = function(event) {
            if (markers[event.event_uid]) return;

            // Сохраняем в локальное хранилище
            eventsData[event.event_uid] = {
                uid: event.event_uid,
                id: event.id, // ID может не прийти в payload, если не настроен сериализатор, но пока не критично
                type: event.detected_type,
                user: event.user_phone, // В payload приходит user_phone
                phone: event.user_phone,
                lat: event.lat,
                lon: event.lon,
                time: new Date().toLocaleTimeString(),
                severity: event.severity
            };

            const marker = L.marker([event.lat, event.lon], {icon: sosIcon}).addTo(map);
            // При клике на маркер открываем панель
            marker.on('click', () => openDetails(event.event_uid));
            markers[event.event_uid] = true;

            // Обновление списка
            const list = document.getElementById('events-list');
            const item = document.createElement('div');
            item.id = `event-card-${event.event_uid}`;
            item.className = "p-3 rounded border-l-4 border-red-500 bg-red-50 hover:bg-red-100 cursor-pointer border-t border-r border-b border-red-200 mb-2 animate-pulse";
            item.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-xs font-bold text-red-600">NEW: ${event.detected_type}</span>
                    <span class="text-xs text-gray-500">Just now</span>
                </div>
                <div class="text-sm font-medium text-gray-900">${event.user_phone}</div>
            `;
            item.onclick = () => openDetails(event.event_uid);
            list.prepend(item);

            // Звук
            try { new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play(); } catch(e) {}

            openDetails(event.event_uid);
        };

        // Рендеринг существующих
        Object.values(eventsData).forEach(data => {
            const marker = L.marker([data.lat, data.lon], {icon: sosIcon}).addTo(map);
            marker.on('click', () => openDetails(data.uid));
            markers[data.uid] = true;
        });

        // WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = protocol + window.location.host + '/ws/sos_events/';
        const statusDiv = document.getElementById('connection-status');
        const pingDot = document.getElementById('ping-dot');

        function connectWs() {
            const socket = new WebSocket(wsUrl);
            socket.onopen = () => {
                statusDiv.textContent = "ONLINE";
                statusDiv.className = "px-3 py-1 rounded text-xs font-bold bg-green-100 text-green-800 border border-green-200";
                pingDot.classList.remove('hidden');
            };
            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'sos_event') addMarker(data.payload);
            };
            socket.onclose = () => {
                statusDiv.textContent = "OFFLINE";
                statusDiv.className = "px-3 py-1 rounded text-xs font-bold bg-red-100 text-red-800 border border-red-200";
                pingDot.classList.add('hidden');
                setTimeout(connectWs, 3000);
            };
        }
        connectWs();
    });
</script>
{% endblock %}