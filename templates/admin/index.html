{% extends 'unfold/layouts/base.html' %}
{% load i18n %}

{% block content %}
<div class="flex flex-col gap-6">

    <!-- 1. Блок KPI -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
        {% for item in kpi %}
        <!-- bg-white border-gray-200 - фиксированные светлые цвета -->
        <div class="rounded-lg shadow-sm p-5 bg-white border border-gray-200 transition-transform hover:scale-105">
            <div class="flex justify-between items-start">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">
                        {{ item.title }}
                    </span>
                    <span class="text-3xl font-bold mt-2 {{ item.color }}">
                        {{ item.metric }}
                    </span>
                </div>
                <div class="p-2 rounded-lg bg-gray-50">
                    <span class="material-symbols-outlined {{ item.color }} text-xl">
                        {{ item.icon }}
                    </span>
                </div>
            </div>
            <div class="mt-4 pt-2 border-t border-gray-100 flex items-center text-xs text-gray-400">
                <span class="material-symbols-outlined text-sm mr-1">info</span>
                {{ item.footer }}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 2. Карта флота -->
    <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
        <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-700">Карта активности устройств</h2>
            <span class="text-xs text-gray-500">Последние известные координаты</span>
        </div>
        <div class="relative w-full h-96 bg-gray-100">
            <div id="fleet-map" class="absolute inset-0 z-0"></div>
        </div>
    </div>

    <!-- 3. Графики -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for chart in charts %}
            <div class="bg-white rounded-lg shadow p-4 border border-gray-200 flex flex-col">
                <h3 class="text-lg font-medium mb-4 text-gray-900">{{ chart.title }}</h3>
                <div class="relative h-72 w-full">
                    <canvas id="chart-{{ forloop.counter }}"></canvas>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* Стили маркера */
    .custom-pin { background: transparent; border: none; }
</style>

<!-- Скрипты -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- КАРТА ---
        const mapEl = document.getElementById('fleet-map');
        if (mapEl) {
            const map = L.map('fleet-map').setView([41.311, 69.240], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 200);

            const devices = {{ devices_json|safe }};
            if (devices && devices.length > 0) {
                const bounds = L.latLngBounds();
                devices.forEach(device => {
                    const color = device.is_online ? '#10b981' : '#6b7280';
                    const markerHtml = `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`;
                    const icon = L.divIcon({ className: 'custom-pin', html: markerHtml, iconSize: [14, 14], iconAnchor: [7, 7] });
                    if (device.lat && device.lon) {
                        const marker = L.marker([device.lat, device.lon], {icon: icon}).addTo(map)
                         .bindPopup(`<div style="text-align:center; color:black;"><b>${device.model}</b><br>${device.owner}<br><b>${device.battery}%</b></div>`);
                         bounds.extend(marker.getLatLng());
                    }
                });
                if (Object.keys(bounds).length > 0) map.fitBounds(bounds, {padding: [50, 50]});
            }
        }

        // --- ГРАФИКИ ---
        const chartsData = {{ charts_json|safe }};
        if (chartsData) {
            chartsData.forEach((chartData, index) => {
                const ctx = document.getElementById(`chart-${index + 1}`);
                if (ctx) {
                    new Chart(ctx.getContext('2d'), {
                        type: chartData.type,
                        data: { labels: chartData.labels, datasets: chartData.datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#374151', usePointStyle: true, padding: 20 } } },
                            scales: chartData.type === 'line' ? {
                                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#374151' } },
                                x: { grid: { display: false }, ticks: { color: '#374151' } }
                            } : {}
                        }
                    });
                }
            });
        }
    });
</script>
{% endblock %}