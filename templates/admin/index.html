{% extends 'unfold/layouts/base.html' %}
{% load i18n %}

{% block content %}
<div class="flex flex-col gap-8 pb-8">

    <!-- Приветственный баннер -->
    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-violet-600 via-purple-600 to-indigo-700 p-8 shadow-2xl">
        <div class="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]"></div>
        <div class="relative z-10">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">
                        Добро пожаловать в MDD Platform
                    </h1>
                    <p class="text-purple-100 text-lg">
                        Оперативный мониторинг и управление системой безопасности
                    </p>
                </div>
                <div class="hidden lg:flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-white/80 text-sm">Сегодня</div>
                        <div class="text-white text-xl font-semibold" id="current-date"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="absolute -right-10 -bottom-10 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
        <div class="absolute -left-10 -top-10 w-48 h-48 bg-white/10 rounded-full blur-3xl"></div>
    </div>

    <!-- KPI Cards с градиентами -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
        {% for item in kpi %}
        <div class="group relative overflow-hidden rounded-2xl bg-white shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
            <!-- Градиентный фон при hover -->
            <div class="absolute inset-0 bg-gradient-to-br from-{{ item.gradient_from|default:'blue' }}-50 to-{{ item.gradient_to|default:'purple' }}-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

            <div class="relative p-6">
                <!-- Иконка с анимированным фоном -->
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">
                            {{ item.title }}
                        </span>
                    </div>
                    <div class="relative">
                        <div class="absolute inset-0 bg-gradient-to-br from-{{ item.gradient_from|default:'blue' }}-400 to-{{ item.gradient_to|default:'purple' }}-500 rounded-xl blur opacity-40 group-hover:opacity-70 transition-opacity"></div>
                        <div class="relative p-3 rounded-xl bg-gradient-to-br from-{{ item.gradient_from|default:'blue' }}-500 to-{{ item.gradient_to|default:'purple' }}-600 shadow-lg transform group-hover:scale-110 transition-transform duration-300">
                            <span class="material-symbols-outlined text-white text-2xl">
                                {{ item.icon }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Метрика -->
                <div class="mb-4">
                    <span class="text-4xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">
                        {{ item.metric }}
                    </span>
                </div>

                <!-- Футер с индикатором -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="material-symbols-outlined text-base">{{ item.footer_icon|default:'info' }}</span>
                        <span>{{ item.footer }}</span>
                    </div>
                    {% if item.trend %}
                    <div class="flex items-center gap-1 text-xs font-semibold {% if item.trend > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        <span class="material-symbols-outlined text-sm">
                            {% if item.trend > 0 %}trending_up{% else %}trending_down{% endif %}
                        </span>
                        {{ item.trend }}%
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Декоративный элемент -->
            <div class="absolute -right-8 -bottom-8 w-32 h-32 bg-gradient-to-br from-{{ item.gradient_from|default:'blue' }}-200 to-{{ item.gradient_to|default:'purple' }}-300 rounded-full opacity-20 group-hover:opacity-30 transition-opacity blur-2xl"></div>
        </div>
        {% endfor %}
    </div>

    <!-- Карта флота с улучшенным дизайном -->
    <div class="relative overflow-hidden rounded-2xl bg-white shadow-xl border border-gray-100">
        <!-- Заголовок с градиентом -->
        <div class="relative overflow-hidden bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 px-6 py-5">
            <div class="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]"></div>
            <div class="relative flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-white/10 backdrop-blur-sm">
                        <span class="material-symbols-outlined text-white text-xl">map</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Карта активности устройств</h2>
                        <p class="text-slate-300 text-sm">В реальном времени</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/20 border border-green-400/30">
                        <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                        <span class="text-green-100 text-sm font-medium">Live</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Карта -->
        <div class="relative w-full h-[500px] bg-gray-50">
            <div id="fleet-map" class="absolute inset-0 z-0"></div>
            <!-- Легенда -->
            <div class="absolute bottom-4 left-4 z-10 bg-white/95 backdrop-blur-md rounded-xl shadow-xl p-4 border border-gray-200">
                <div class="text-xs font-semibold text-gray-700 mb-2">Статус устройств</div>
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/50"></div>
                        <span class="text-xs text-gray-600">Онлайн</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-gray-400 shadow-lg shadow-gray-400/50"></div>
                        <span class="text-xs text-gray-600">Оффлайн</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% for chart in charts %}
        <div class="group relative overflow-hidden rounded-2xl bg-white shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-2xl">
            <!-- Градиентная полоса сверху -->
            <div class="h-1.5 bg-gradient-to-r from-violet-500 via-purple-500 to-indigo-500"></div>

            <div class="p-6">
                <!-- Заголовок графика -->
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <span class="material-symbols-outlined text-violet-600">{{ chart.icon|default:'analytics' }}</span>
                        {{ chart.title }}
                    </h3>
                    <button class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="material-symbols-outlined text-gray-400 text-xl">more_vert</span>
                    </button>
                </div>

                <!-- График -->
                <div class="relative h-80 w-full">
                    <canvas id="chart-{{ forloop.counter }}"></canvas>
                </div>

                <!-- Статистика под графиком -->
                {% if chart.stats %}
                <div class="mt-6 pt-6 border-t border-gray-100 grid grid-cols-3 gap-4">
                    {% for stat in chart.stats %}
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900">{{ stat.value }}</div>
                        <div class="text-xs text-gray-500 mt-1">{{ stat.label }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Декоративный градиент -->
            <div class="absolute inset-0 bg-gradient-to-br from-violet-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
        </div>
        {% endfor %}
    </div>

    <!-- Быстрые действия -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for nav_item in navigation %}
        <a href="{{ nav_item.link }}" class="group relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-50 to-white p-6 shadow-lg border border-gray-200 transition-all duration-300 hover:shadow-2xl hover:scale-[1.02]">
            <div class="flex items-center gap-4">
                <div class="p-3 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 shadow-lg group-hover:shadow-violet-500/50 transition-all">
                    <span class="material-symbols-outlined text-white text-2xl">{{ nav_item.icon }}</span>
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-900 group-hover:text-violet-600 transition-colors">
                        {{ nav_item.title }}
                    </div>
                    <div class="text-sm text-gray-500 mt-1">{{ nav_item.description|default:'Перейти' }}</div>
                </div>
                <span class="material-symbols-outlined text-gray-400 group-hover:text-violet-600 group-hover:translate-x-1 transition-all">arrow_forward</span>
            </div>
        </a>
        {% endfor %}
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
    /* Анимация появления */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fadeInUp {
        animation: fadeInUp 0.6s ease-out;
    }

    /* Градиентная сетка для фона */
    .bg-grid-white\/\[0\.05\] {
        background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                          linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
    }

    /* Кастомные маркеры */
    .custom-marker {
        background: transparent;
        border: none;
    }

    .custom-marker-inner {
        position: relative;
        width: 40px;
        height: 40px;
    }

    .custom-marker-inner::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle, rgba(16, 185, 129, 0.4) 0%, transparent 70%);
        animation: pulse-wave 2s ease-out infinite;
    }

    .custom-marker-dot {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    @keyframes pulse-wave {
        0% {
            transform: scale(0.8);
            opacity: 1;
        }
        100% {
            transform: scale(2);
            opacity: 0;
        }
    }

    /* Стили для Leaflet popup */
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    .leaflet-popup-content {
        margin: 12px;
        font-family: inherit;
    }
</style>

<!-- Скрипты -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Обновление даты
        const dateEl = document.getElementById('current-date');
        if (dateEl) {
            const now = new Date();
            dateEl.textContent = now.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                weekday: 'short'
            });
        }

        // --- КАРТА с кластеризацией ---
        const mapEl = document.getElementById('fleet-map');
        if (mapEl) {
            const map = L.map('fleet-map', {
                zoomControl: true,
                scrollWheelZoom: true
            }).setView([41.311, 69.240], 11);

            // Темная тема карты (опционально)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            setTimeout(() => { map.invalidateSize(); }, 200);

            const devices = {{ devices_json|safe }};

            if (devices && devices.length > 0) {
                const markers = L.markerClusterGroup({
                    iconCreateFunction: function(cluster) {
                        const count = cluster.getChildCount();
                        return L.divIcon({
                            html: `<div class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-br from-violet-500 to-purple-600 text-white font-bold shadow-lg">${count}</div>`,
                            className: 'custom-cluster',
                            iconSize: [48, 48]
                        });
                    }
                });

                const bounds = L.latLngBounds();

                devices.forEach(device => {
                    const color = device.is_online ? '#10b981' : '#6b7280';

                    const markerHtml = `
                        <div class="custom-marker-inner">
                            <div class="custom-marker-dot" style="background-color: ${color};"></div>
                        </div>
                    `;

                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: markerHtml,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });

                    if (device.lat && device.lon) {
                        const marker = L.marker([device.lat, device.lon], {icon: icon})
                            .bindPopup(`
                                <div class="p-2 min-w-[200px]">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-3 h-3 rounded-full" style="background-color: ${color};"></div>
                                        <span class="font-bold text-gray-900">${device.model}</span>
                                    </div>
                                    <div class="text-sm text-gray-600 mb-1">
                                        <span class="material-symbols-outlined text-xs align-middle">person</span>
                                        ${device.owner}
                                    </div>
                                    <div class="flex items-center gap-4 mt-3 pt-2 border-t border-gray-100">
                                        <div class="flex items-center gap-1 text-xs text-gray-500">
                                            <span class="material-symbols-outlined text-sm">battery_full</span>
                                            <span class="font-semibold">${device.battery}%</span>
                                        </div>
                                        <div class="flex items-center gap-1 text-xs">
                                            <span class="w-2 h-2 rounded-full ${device.is_online ? 'bg-green-500' : 'bg-gray-400'}"></span>
                                            <span class="font-medium">${device.is_online ? 'Онлайн' : 'Оффлайн'}</span>
                                        </div>
                                    </div>
                                </div>
                            `, {
                                className: 'modern-popup'
                            });

                        markers.addLayer(marker);
                        bounds.extend(marker.getLatLng());
                    }
                });

                map.addLayer(markers);

                if (Object.keys(bounds).length > 0) {
                    map.fitBounds(bounds, {padding: [50, 50], maxZoom: 13});
                }
            }
        }

        // --- ГРАФИКИ с градиентами ---
        const chartsData = {{ charts_json|safe }};

        if (chartsData) {
            chartsData.forEach((chartData, index) => {
                const ctx = document.getElementById(`chart-${index + 1}`);
                if (ctx) {
                    const chartCtx = ctx.getContext('2d');

                    // Создаем градиенты для datasets
                    const datasets = chartData.datasets.map((dataset, i) => {
                        if (chartData.type === 'line') {
                            const gradient = chartCtx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.3)');
                            gradient.addColorStop(1, 'rgba(139, 92, 246, 0)');

                            return {
                                ...dataset,
                                backgroundColor: gradient,
                                borderColor: '#8b5cf6',
                                borderWidth: 3,
                                pointBackgroundColor: '#8b5cf6',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.4,
                                fill: true
                            };
                        } else if (chartData.type === 'doughnut') {
                            return {
                                ...dataset,
                                backgroundColor: [
                                    '#8b5cf6', '#6366f1', '#3b82f6',
                                    '#06b6d4', '#10b981', '#f59e0b'
                                ],
                                borderWidth: 0,
                                hoverOffset: 10
                            };
                        }
                        return dataset;
                    });

                    new Chart(chartCtx, {
                        type: chartData.type,
                        data: {
                            labels: chartData.labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        font: {
                                            size: 12,
                                            family: "'Inter', sans-serif"
                                        },
                                        color: '#374151'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    }
                                }
                            },
                            scales: chartData.type === 'line' ? {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11
                                        },
                                        padding: 10
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11
                                        },
                                        padding: 10
                                    }
                                }
                            } : {},
                            animation: {
                                duration: 2000,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                }
            });
        }

        // Анимация появления карточек
        const cards = document.querySelectorAll('.group');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('animate-fadeInUp');
            }, index * 50);
        });
    });
</script>
{% endblock %}